
### 大规模 Cron 系统

在常规实现里，Cron 只能运行在一台机器上。大规模系统部署需要将 Cron 分布到多台机器上。

为了提升 Cron 的可靠性，我们将实际进程与物理机器分开。如果我们想要运行一个服务，仅仅通过指明该服务的资源要求，以及应该运行的数据中心即可。数据中心内部的任务分发系统(该系统应该是高可靠的)来决定一台或者多台机器来运行你的服务，同时该系统还会处理物理机的故障问题。这样一来，运行一个任务就仅仅等于向数据中心分发器发送一个RPC了。

然而，这个过程是需要一定时间的。一台损坏的物理机需要一定时间才能被发现，通常是在某项健康检查超时时被发现，然后任务分发系统会将你的服务迁移到另外一台机器上，消耗一定时间重新安装软件并且启动新的进程。

因为进程迁移到另外一台虚拟机上的过程可能会导致存储在原有机器上的所有本地状态丢失(除非采用某种在线迁移技术)。同时整个系统的重新分发过程可能会超过系统所定义的最小时间间隔。于是我们需要一些针对数据丢失和重新启动时间过长的应对措施。为了保持本地状态，我们可能会简单地将状态存储在一个分布式文件系统中。在服务启动的时候，直接通过该分布式文件系统查询并且启动那些在系统迁移过程中没有运行的任务。但是这种解决方案可能无法解决即时性的要求: 如果某个任务需要每 5 分钟运行一次，由于 Cron 服务迁移导致的每次一分钟，或者两分钟的延迟可能是无法接受的。在这种情况下，热备任务，在主任务迁移的时候及时介入恢复服务可以极大降低系统的不可用时间。

将进程启动过程与具体运行的机器分离使得整个 Cron 系统需要处理"部分启动"的故障类型。Cron 任务的多样性意味着某些任务在启动的时候可能需要发送多个 RPC，有时我们会遇到某个 RPC 成功，而其他 RPC 不成功的问题。Cron 故障恢复过程必须要处理这种情况。

在讨论故障模式的时候，一个数据中心相比单个物理机来说是一个更加丰富的生态系统。Cron 服务，当大规模部署时从一个简单的二进制文件变成了一个具有许多明显和不明显的依赖的服务。对 Cron 这样的基础服务来说，必须保证在数据中心遇到部分故障的时候，整个服务仍然能够正常运行。通过在数据中心内部分散地同时运行多份调度器的副本，我们可以避免单个供电单元故障造成整个 Cron 系统不可用。

### 跟踪 Cron 任务的状态

跟踪任务的状态有两个选项:
- 将数据存储在一个可用度很高的外部分布式存储上
- 系统内部自行存储一些(很小量)状态信息

当 Google 设计分布式 Cron 任务的时候，我们选择的是第二个选项。这样选择的原因有以下几个:
- 分布式文件系统，通常用来存储非常大的文件(例如，网页爬虫程序的输出文件)，而我们需要存储的 Cron 任务状态信息通常来说是非常小的。小型写操作在分布式文件系统上的开销很高，同时延迟也很高，因为这些文件系统就不是为这种类型的写操作进行优化的。
- 基础服务，也就是那些失效时会带来许多副作用的(就像 Cron 这样的)服务应该依赖越少越好。即使数据中心的一部分出现故障，Cron 服务也应该能够持续工作一段时间。Cron 服务应该可以独立于下游系统而运行，以便服务更多的内部用户。

