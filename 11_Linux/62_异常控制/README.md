
## 异常的类别
- 异常可以分为四类

| 类别 | 原因 | 异步/同步 | 返回行为 |
|:----:|:----:|:---------:|:--------:|
| 中断 | 来自 I/O 设备的信号 | 异步 | 总是返回到下一条指令 |
| 陷阱 | 有意的异常 | 同步 | 总是返回到一下条指令 |
| 故障 | 潜在可恢复的错误 | 同步 | 可能返回到当前指令 |
| 终止 | 不可恢复的错误 | 同步 | 不会返回 |

## 中断
- 中断是异步发生的，是来自处理器外部的 I/O 设备的信号的结束。

## 陷阱和系统调用
- 陷阱最重要的用途是在用户程序和内核之间提供一个像过程一样的接口，叫做系统调用。
- 用户程序经常需要向内核请求服务，比如 read、fork、execve、exit 等。这涉及到到用户态与内核态之间的切换。

## 故障
- 故障由错误引起，它可能被故障处理程序修正。
- 一个经典的故障示例是缺页异常，如果异常处理程序能够修复此异常，那么就会返回指令继续。否则就会引发段错误，终止程序。

## 终止
- 不可恢复的致命错误造成的结果，通常是一些硬件错误。
- 终止处理程序从不将控制返回给应用程序。

## 进程的三种状态
- 运行。正在执行，或者**正在等待被内核调度执行**。
- 停止。进程的执行被挂起，**且不会被调度**。当收到 SIGSTOP, SIGTSTP, SIDTTIN 或者 SIGTTOU 信号时，进程就停止，并且保持停止直到它收到一个 SIGCONT 信号，在这个时刻，进程再次开始运行。
- 终止。进程永远的停止了。三种原因会造成进程终止:
    + 收到一个终止进程的信号
    + 从主程序中返回
    + 调用 exit 函数

## 上下文切换与内核调度
- 内核为每个进程维持一下上下文。
- 在进程执行的某些时刻，内核可以决定抢占当前进程，并重新开始一个先前被抢占的进程，这种决定就叫做**调度(schedule)**，它是由内核中的调度器执行的。
- 在内核调度了一个新的进程运行后，它就抢占当前进程，并使用一种称为**上下文切换**的机制来将控制转移到新的进程。
- 上下文切换过程:
    + 保存当前进程上下文
    + 恢复某个先前被抢占的进程被保存的上下文
    + 将控制传递给这个新恢复的进程

## 引发上下文切换的因素
- 内核抢占式的进程调度。
- 当内核代表用户执行系统调用时，可能会发生上下文切换。比如 read 阻塞时内核可以让当前进程休眠，切换到另一进程。或者显式 sleep 或 pause 调用，让调用进程休眠。
- 中断也可能引发上下文切换。

## 回收子进程
- 当一个进程由于某种原因终止时，内核并不是立即把它从系统中清除。相反，进程被保持在一种已终止的状态，直到被父进程回收。当父进程回收已终止的子进程时，内核将子进程的退出状态传递给父进程，然后抛弃已终止的进程，从此时开始，该进程就不存在了。
- 一个终止了但还未被回收的进程称为僵尸进程。
- 如果父进程没有回收它的僵尸子进程就终止了，那么内核就会安排 init 进程回收它们。
- 一个进程可以通过调用 `waitpid` 函数来等待它的子进程终止或者停止。

## waitpid 函数
- 描述
  ```c
    #include <sys/types.h>
    #include <sys/wait.h>
    
    pid_t waitpid(pid_t pid, int *status, int options);
  ```
  默认地(当 options=0时)，waitpid 挂起调用进程的执行，直到它的等待集合中的一个子进程终止。
- 判定等待集合的成员： 由参数 pid 来确定
    + 如果 pid > 0 ，那么等待集合就是一个单独的子进程，它的进程ID等于pid
    + 如果 pid = -1，那么等待集合就是由父进程所有的子进程组成的。
- 修改默认行为
    + `WNOHANG`: 如果等待集合中的任何子进程都还没有终止，那么就立即返回(返回值为0)。
    + `WUNTRACED`: 挂起调用进程的执行，直到等待集合中的一个进程变成已终止或者被停止。
    + `WNOHANG|WUNTRACED`: 立即返回。
- 检查已回收子进程的退出状态
    + WIFEXITED(status): 如果子进程通过调用 exit 或者一个返回(return)正常终止，就返回真。
    + WEXITSTATUS(status): 返回一个正常终止的子进程的退出状态。只有在 WIFEXITED 返回为真时，才会定义这个状态。
    + WIFSIGNALED(status): 如果子进程是因为一个未被捕获的信号终止的，那么就返回真。
    + WTERMSIG(status): 返回导致子进程终止的信号的值。只有在 WIFSIGNALED 返回为真时，才定义这个状态。
    + WIFSTOPPED(status): 如果引起返回的子进程当前是被停止的，那么就返回真。
    + WSTOPSIG(status): 返回引起子进程停止的信号的值。只有在 WIFSTOPPED 返回为真时，才定义这个状态。
- 错误条件
    + 如果调用进程没有子进程，那么 waitpid 返回 -1，并且设置 errno 为 ECHILD。
    + 如果 waitpid 函数被一个信号中断，那么它返回 -1，并设置 errno 为 EINTR。

 
