
存储器系统(memory system)是一个具有不同容量、成本和访问时间的存储设备的层次结构。

CPU 寄存器保存着最常用的数据。靠近 CPU 的小的、快速的高速缓存存储器(cache memory)作为一部分存储在相对慢速的主存储器(main memory，简称主存)中的数据和指令的缓冲区域。主存又暂时存放存储在容量较大的、慢速磁盘上的数据，而这些磁盘常常又作为存储在通过网络连接的其他机器的磁盘或磁带上的数据的缓冲区域。


### 各存储器层次结构上的设备

存储器系统是一个具有不同容量、成本和访问时间的存储设备的层次结构。存储层次从高到低一般分为:
- 寄存器: 用作 CPU 指令集运算的存储单元
- 高速缓存: 也称为 CPU 缓存、SRAM 等
- 主存: 通俗意义上的内存就是指这个，学名 DRAM。增强型的 DRAM 有 SDRAM(Synchronous DRAM, 同步DRAM) 以及 DDR-SDRAM(Double Data-rate Synchronous DRAM, 双倍数据速率同步DRAM)
- 辅存: 也称为外存，如磁盘、固态硬盘等

存储层次越高，其访问速度越快，造价也越昂贵。


### 为什么要进行层次化存储

1. 存储访问对应用程序的性能有着巨大的影响。如果程序中需要的数据是存储在 CPU 寄存器中的，那么在指令的执行期间，在零个周期内就能访问到它们。如果存储在高速缓存中，需要 1~30 个周期。如果存储在主存中，需要 50~200 个周期。而如果存储在磁盘上，需要大约几千万个周期！
2. 在计算机程序中，倾向于多次地访问相同的数据项集合，或是倾向于访问邻近的数据项集合。而具有良好局部性的程序比局部性差的程序更多地倾向于从存储层次结构中较高层次处访问数据项，从而使程序运行得更快。 
3. 经济效益考虑。

### 缓存

随着技术的发展，内存容量变得越来越大，带宽(CPU访问内存带宽，或存储器总线带宽)也在增加(但是增加的幅度比处理器的吞吐量要小)，但延迟并没有减少，而是越来越大。
处理器吞吐量与内存吞吐量和延迟的差异越来越大，这称为内存墙。

现代处理器通过几种方式来减小这种差距实际产生的影响:
- 每次内存访问会读取周围的多个数据，因为这些数据随后极有可能会被用到，称为`内存预取`
- 采用容量小但更快的存储器(称为缓存)进行存储，如果访问的数据在缓存中，那么就无须去访问内存
- 支持向量访问和同时处理多个访问请求，通过大量并行访问来掩盖延迟

另外，处理器对数据的访问具有局部性，又可分为"时间局部性"和"空间局部性"。
- 时间局部性是指当前被访问的数据随后有可能再次被访问到。
- 空间局部性是指当前访问地址附近的地址可能随后被访问到。

现代处理器通过在内存和核心之间增加缓存以利用局部性增强程序性能，这样可以用远低于缓存的价格换取接近缓存的速度。

缓存层次结构
- 为了更好地利用程序访问内存/缓存的局部性，现代处理器采用了多层次的、容量不同和性能不同的缓存，其中上一级缓存容量比下一级缓存小，但是延迟更小、带宽更大。
- 比如 Intel Haswell CPU 一级缓存大小为 32KB，延迟为 3 个周期，读吞吐量为每周期 64 bytes。其二级缓存大小为 256KB，延迟为 11 个周期，读吞吐量为每周期 64 字节。
- 现代处理器至少具有二级缓存，某些高端多核处理器还具有三级缓存。各级缓存采用类似金字塔式的层级存储结构，寄存器缓存一级缓存，一级缓存缓存二级缓存，二级缓存缓存三级缓存，三级缓存RAM，RAM 缓存硬盘、网络等，而硬盘缓存远程请求等。
- 由于这种金字塔的保存方式，某些数据可能同时被缓存在某个核心的多个缓存层次上(也有可能只缓存在某个层次上)。在多核处理器上，某个数据还可能同时被多个核心上的缓存所缓存(这会产生伪共享问题)。

缓存命中率
- 一次内存访问，如果访问的数据在缓存中，则称为`缓存命中`，如果不在，则称为缓存不命中。缓存命中率就是指程序执行过程中缓存命中的次数占总访存次数的百分比。
- 通常，程序的缓存优化过程就是提高缓存命中率的过程。

缓存一致性问题
- 某个进程读入一个磁盘文件，并在进程中对该文件进行修改。如果此时修改结果没有同步到磁盘文件，而其他进程又去读这个磁盘文件的话，就会产生文件不一致的情况。
- 同样地，多核处理器中，某个核心对缓存数据的修改如果无法及时同步到内存，而其他核心又要读取内存中的这个数据时，就会产生缓存一致性问题。
- 为了读取数据的正确性，一旦一个核心更改了某个地址的数据，其他的核心就需要对缓存的该地址数据失效。这通过硬件来实现，可以理解的是，其处理代价肯定与处理器的数目成正相关。

软件开发人员应该意识到，对于性能限制在内存/缓存上的程序来说，缓存能够显著增加程序的实际性能，因此要编写缓存友好的代码，同时在多核的条件下要注意避免伪共享问题导致的性能损失。

