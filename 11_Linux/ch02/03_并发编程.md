

### 概念

线程级并行将处理器内部的并行由指令级和向量级上升到线程级，旨在通过线程级的并行来增加指令吞吐量，提高处理器的资源利用率。

线程级并行的思想是:
- 在多核处理器上使用多线程技术，使得多核处理器的多个核心上有多个流水线同时执行，以利用多个核心的计算能力。
- 在单核处理器上，当某一个线程由于等待数据到达而空闲时，可以立即导入其他的就绪线程来执行，使核心能够始终处于忙碌状态。

### 内核线程和用户线程

运行在用户空间(运行时)的线程称为用户线程，同理运行在内核空间(操作系统)的线程称为内核线程。

用户线程由库管理，无须操作系统支持，因此其创建、调度无须干扰操作系统的运行，故消耗少。内核线程的创建、调度和销毁都由操作系统负责，这是因为只有操作系统了解内核线程的运行情况。

由于操作系统不会去调度用户线程，所以即使用户线程由于等待资源分配而阻塞，操作系统也不会将该用户线程所占用的资源(如CPU)切换给其他线程使用。

用户线程的这个缺点刚好是内核线程的优点，而内核线程的缺点以刚好是用户线程的优点。如果能够合理地将用户线程映射到内核线程上，就可以实现操作系统对用户线程的调度，同时消耗系统资源尽可能地少。

映射方式可以有 4 种: 一对一，一对多，多对一，多对多。

Linux 下的 pthread 作为用户级线程库，就是通过与内核线程一对一方式映射实现的。

### 多核多线程并行问题

多核处理器上的所有核心共享内存，但可以有各自的一、二级缓存和寄存器。

由于资源共享，在多核处理器上使用线程级并行需要注意的问题有以下几个:

1. 线程过多

- 如果系统上的线程数量远远超过核心的数量，那么就会导致频繁的上下文切换，进而降低性能，如缓存污染。
- 通常支持超线程的多核处理器能够使用的线程数最多是物理核心数的 2 倍(即逻辑核心数)，再增加就有可能降低程序的性能。

> 超线程概念:
> Intel 的一些高端机器支持称为"超线程"(Hyper-Threading, HT)的技术，其实现是将一个物理核模拟成两个逻辑核，可并行执行两个线程，让单核也能够达到线程级并行计算，减少了 CPU 的闲置时间，提高了 CPU 的运行效率。
> 超线程技术需要主板芯片组和操作系统的配合，才能充分发挥其效能。

2. 数据竞争

- 当多个线程读写同一共享数据时，便会产生竞争。比如两个线程对同一个共享数据执行操作时，就需要同步以保证结果的一致性。
- 同步会导致线程之间的互相等待，从而降低了性能。

3. 死锁

线程发生死锁时，处理器会一直询问需要的资源是否可用。但是线程都在相互等待其他线程释放资源，谁也无法前进一步，处理一种"僵死"的状态。

4. 饿死

当一个或多个线程永远没有机会调度到处理器上执行，就会陷入到漫长的等待状态。

5. 伪共享

当多个线程读写的数据映射到同一条缓存线上时(如三级缓存)，如果一个线程更改了数据，那么其他线程对该数据的缓存就会失效。如果线程频繁地更改数据，硬件就需要不停地更新缓存线，这使性能从独享缓存的水平降低到共享缓存或内存的水平。


### 多线程程序在多核和单核上运行的不同

多线程程序在单核和多核上运行具有不同的特点:

1. 锁

- 多线程在多核心上会因锁的使用而产生同步消耗，此时有些处理器可能空闲。
- 在单核上影响的只是持有和释放锁的时间，处理器时刻在运行着。

2. 负载均衡

- 单核上不用考虑负载均衡，因为线程轮流执行，不会存在线程等待问题。
- 多核上执行时，最终时间由运行时间最长的线程决定。

3. 任务调度

- 单核上，任务调度完全是操作系统的工作，无须程序员干预。
- 多核上运行时，程序员要合理地在核心间分配任务，以尽量同时结束计算。


### Actor 模型 - 实现并发的另一种办法

- [Actor模型](https://www.jianshu.com/p/d803e2a7de8e)

如何从锁模型过渡到 Actor 模型？
- 比如在同一个进程中的两个线程，共用一个队列读写时，就必须进行锁保护。现在，将这两个线程分别放到两个进程中，IPC 通信管道就可以看作是一个队列，但因为是在两个进程中，所以就不需要再进行锁保护了。
- 锁模型体现的是并发性中的强一致性与弱隔离性，Actor 模型体现的是并发性中的弱一致性与强隔离性。

Actor 模型中邮箱中消息过多怎么办？
- 发件者不断的发送消息，收件者很长时间不打开邮箱，这个时候邮箱中积累了大量邮件，某个时刻，收件者打开邮件，这时邮件该如何反应到界面上呢？
- 我想，每封邮件应该是独立于其他邮件的全量信息（比如应该是这个对象的值是 10，而不应该是对这个对象的值加 10），还应该设置一个调度器适时清除前面(按时间序)的冗余信息(这可能要为每种邮件设置一个 id 了)。
