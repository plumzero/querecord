
### 元命令查询

* 查看所有数据库的详细信息: `\l+`
* 查看所有角色: `\duS`
* 查看所在数据库中表的详细信息: `\dt+`
* 查看所在数据库中索引的详细信息: `\di+`
* 查看所在数据库中序列的详细信息: `\ds+`
* 查看表的定义: `\d 表名`
* 查看所有的 schema: `\dnS+`
* 查看所有的类型: `\dTS+`

事件操作: 将之后的查询结果输出到指定文件
```sh
    mydb=> \o /tmp/out.txt
    mydb=> select * from mytable;
    mydb=> \o               # 终止输出
```

事件操作: 导出导入数据
```sh
    mydb=> \copy test_copy TO '/home/postgres/test_copy2.csv' WITH csv header;
    mydb=> \copy test_copy FROM '/home/postgres/test_copy_in.txt';
```

事件操作: 从文件中执行命令
```sql
    select id, name from mytable;
```
将上面的语句放入 sql.txt 文件(注意，文件中只能包含可执行的语句，甚至不能包含注释)中，之后在数据库环境中执行。
```sh
    mydb=> \i /tmp/sql.txt
```

### 权限控制

限制角色 pguser 只能访问库 mydb:
```sh
    postgres=# REVOKE CONNECT ON DATABASE mydb FROM PUBLIC;
    postgres=# GRANT CONNECT ON DATABASE mydb TO pguser;
```

限制角色 pguser 只能对 public 中的表查询:
```sh
    postgres=# GRANT SELECT ON ALL TABLES IN SCHEMA public TO pguser WITH GRANT OPTION;
```


### 连接管理

显示系统允许的最大连接数:
```sh
    postgres=# SHOW max_connections;
```

查询当前所有连接的状态:
```sh
    postgres=# SELECT datname, pid, application_name, state FROM pg_stat_activity;
```

查看数据库剩余连接数:
```sh
    postgres=# SELECT max_conn-now_conn AS resi_conn FROM (SELECT setting::int8 AS max_conn, (SELECT count(*) FROM pg_stat_activity) AS now_conn FROM pg_settings WHERE name = 'max_connections') t;
```

关闭当前 state 为 idle(空闲状态)的连接:
```sh
    postgres=# SELECT datname,pid,application_name,state FROM pg_stat_activity;

     datname  |  pid  | application_name | state  
    ----------+-------+------------------+--------
              | 23023 |                  | 
     postgres | 23040 | psql             | active
     airflow  | 23016 |                  | idle
              | 23018 |                  | 
              |   512 |                  | 
              |   511 |                  | 
              |   513 |                  | 
    (7 rows)
    postgres=# SELECT pg_terminate_backend(23016) FROM pg_stat_activity;
```
