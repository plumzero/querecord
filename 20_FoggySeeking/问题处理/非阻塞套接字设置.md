
## 通信模型
```shell
    客户端  <------------>  服务端
    
    write   ------------->  read
    read    <-------------  write
```

客户端与服务端建立连接成功后，客户端与服务端要做一些同步处理，客户端需要将自身一些信息发送给服务端进行保存。具体就是客户端首先发起 write, 服务端 read 后，校验没有问题，会 write 给客户端告知，客户端 read 到服务端回应后，结束。

## 问题叙述

实际测试时，客户端 read 总是失败(返回值 -1)，服务端 read 也会偶尔出现失败(返回值 -1)。

客户端与服务端均将套接字设置为了非阻塞。

发送的数据都很小，本来以为是因为 Nagle，但设置了 TCP_NODELAY 选项后还是有问题。

后来发现是非阻塞设置位置不符合应用场景。

不符合应用场景的设置:
```c
    ioctl(fd, FIONBIO, &on);
    
    // 读写交互操作
```
在读写交互操作之前将套接字设置为非阻塞，一端写了之后，另一端如果检测到可读缓冲区为空(数据还没到达)，read 时就会返回 -1 。

## 解决办法
阻塞读写交互操作，在这之后将套接字设置为非阻塞:
```c
    // 读写交互操作
    
    ioctl(fd, FIONBIO, &on);
```
