
```sql
    CREATE TABLE orders
    (
        item            CHAR(16)        NOT NULL,
        price           REAL            NOT NULL,
        ordered         INTEGER         NOT NULL
    );
```

```sql
    INSERT INTO orders VALUES('almonds', 12, 2),('pecans', 20, 1),('cookies', 10, 60);
```

```sql
    CREATE TABLE warehouses
    (
        stock_item  CHAR(16)    NOT NULL,
        warehouse   CHAR(1)     NOT NULL,
        instock     INTEGER     NOT NULL
    );
```

```sql
    INSERT INTO warehouses VALUES('almonds','A',120),('pecans','A',80),('almonds','B',60),('cookies','B',40),('cookies','A',80);
```

```sql
    SELECT o.item, o.price, o.ordered, w.warehouse, w.instock
        FROM orders AS o
            INNER JOIN warehouses AS w
                ON o.item = w.stock_item AND w.instock >= o.ordered;
```
输出如下:
```sh
       item       | price | ordered | warehouse | instock 
------------------+-------+---------+-----------+---------
 almonds          |    12 |       2 | B         |      60
 almonds          |    12 |       2 | A         |     120
 pecans           |    20 |       1 | A         |      80
 cookies          |    10 |      60 | A         |      80
(4 rows)
```

用 MongoDB 实现同样的效果:

```js
    db.orders.insert([
        { "_id" : 1, "item" : "almonds", "price" : 12, "ordered" : 2 },
        { "_id" : 2, "item" : "pecans", "price" : 20, "ordered" : 1 },
        { "_id" : 3, "item" : "cookies", "price" : 10, "ordered" : 60 }
    ])
```

```js
    db.warehouses.insert([
        { "_id" : 1, "stock_item" : "almonds", warehouse: "A", "instock" : 120 },
        { "_id" : 2, "stock_item" : "pecans", warehouse: "A", "instock" : 80 },
        { "_id" : 3, "stock_item" : "almonds", warehouse: "B", "instock" : 60 },
        { "_id" : 4, "stock_item" : "cookies", warehouse: "B", "instock" : 40 },
        { "_id" : 5, "stock_item" : "cookies", warehouse: "A", "instock" : 80 }
    ])
```

```js
    db.orders.aggregate([
        {
            $lookup: {
                from: 'warehouses',
                let: { order_item: '$item', order_qty: '$ordered' },  // 将 orders 表中的 item 和 ordered 字段视为联查键，分别别名为 order_item 和 order_qty  
                pipeline: [
                    {
                        $match: {
                            $expr: { 
                                $and: [
                                    { $eq: [ '$stock_item',  '$$order_item' ] },
                                    { $gte: [ '$instock', '$$order_qty' ] }
                                ]
                            }
                        }
                    },
                    { $project: { stock_item: 0, _id: 0 } }     // 将 warehouses 表中的某些字段屏蔽
                ],
                as: 'stockdata'
            }
        },
		{
			$unwind: '$stockdata'
		},
		{
			$replaceRoot: { newRoot: { $mergeObjects: [ '$stockdata', '$$ROOT' ] } }
		},
		{ $project: { stockdata: 0, _id: 0 } }
    ])
```
输出如下:
```sh
{ "warehouse" : "A", "instock" : 120, "item" : "almonds", "price" : 12, "ordered" : 2 }
{ "warehouse" : "B", "instock" : 60, "item" : "almonds", "price" : 12, "ordered" : 2 }
{ "warehouse" : "A", "instock" : 80, "item" : "pecans", "price" : 20, "ordered" : 1 }
{ "warehouse" : "A", "instock" : 80, "item" : "cookies", "price" : 10, "ordered" : 60 }
```