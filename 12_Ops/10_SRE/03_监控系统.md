
监控处于整个生产环境需求金字塔模型的最底层，是运营一个可靠的稳定服务不可缺少的部分。

一个大型系统不应该要求运维人员持续关注其中使用的无数个小组件，而是应该自动汇总所有的信息，自动抛弃其中的异常情况。监控系统应该主要从高级服务质量目标层面进行报警，但是也应该保持足够的粒度，可以追踪到某个具体组件。

> 如何将内部变量暴露给监控系统? Google 是这样做的。
> Google 内部产生的每个二进制文件中都默认包含一个 HTTP 服务，同时每种主流编程语言都提供了一个编程接口可以自动注册暴露指定的程序变量。软件服务器作者可以随后对这个变量进行简单地增加操作，或者直接修改这个变量的值。Go 语言中的 expvar 标准库和它的 JSON 输出格式也提供了类似的 API 。

### 监控分级

一个监控系统应该只有三类输出:
- 紧急警报: 需要立即执行处理，如严重情况的报警。
- 工单: 将重要但不紧急的报警发送给工单系统。
- 日志: 不时之需，用来作为历史数据或者服务监控台(dashboard)展示使用。

为了避免运维压力过大，理想情况下，运维压力过载应该是基于数据且可以量化的。这样我们的目标也就可以量化(例如: 每天工单数量 < 5，每次轮值报警事件 < 2 等)。

### 服务质量指标与监控指标

不同系统，其服务质量指标有所侧重:
- 用户可见的服务系统: 可用性、延迟，以及吞吐量。具体比如: 是否能正常处理请求?每个请求花费的的时间?多少请求可以被处理?
- 存储系统: 通常强调延迟、可用性和数据持久性。具体比如: 读写数据需要多少时间?是否可以随时访问数据?数据是否一段时间内还能被读取?
- 大数据系统: 例如数据处理流水线系统，一般来说关心吞吐量和端到端延迟。具体比如: 处理了多少数据?数据从输入到产出需要多少时间?(某些流水线任务还会关注某个单独处理阶段的延迟)
- 所有系统都应该关注: 正确性。是否返回了正确的回复，是否读取了正确的数据，或者进行了正确的数据分析操作。

标准化一些常见的 SLI，以避免每次都要重新评估它们。这样任何一个符合标准定义模板的服务可以不需要再次自己定义 SLI。
- `汇总间隔`: 每 1 分钟汇总一次
- `汇总范围`: 集群中的全部任务
- `度量频率`: 每 10 秒一次
- `包含哪些请求`: 从黑盒监控任务发来的 HTTP GET 请求
- `数据如何获取`: 通过监控系统获取服务器端信息得到
- `数据访问延迟`: 从收到请求到最后一个字节被发出

监控系统的 4 个黄金指标。如果我们只能监控用户可见系统的指标，那么就应该监控这 4 个:
- 延迟: 服务处理某个请求所需要的时间。这里要区分成功请求和失败请求。
- 流量: 使用系统中的某个高层次的指标针对系统负载需求所进行的度量。对 Web 服务器来说，该指标通常是每秒 HTTP 请求数量，同时可能按请求类型分类(静态请求与动态请求)。
- 错误: 请求失败的速率，要么是显式失败(例如错误码返回)，要么是隐式失败(例如返回内容不合要求)，或者策略原因导致的失败(例如未在规定时间内返回)。不同的错误，其监控方式也不一样: 在负载均衡器上检测 HTTP 500 请求可能足够抓住所有的完全失败的请求，但是只有端到端的系统才能检测到返回错误内容这种故障类型。
- 饱和度: 服务容量有多"满"。通常是系统中目前最为受限的某种资源的某个具体指标的度量。(在内存受限的系统中，即为内存；在I/O受限的系统中，即为I/O)。这里要注意，很多系统在达到 100% 利用率之前性能会严重下降，所以增加一个利用率目标也是很重要的。

### 监控指标的收集方式

利用配置文件配置需要收集的目标列表，目标位置可以使用各种地址解析服务支持的格式。这个目标列表可以(也通常)是动态变化的，所以一套服务发现体系可以降低监控系统的配置维护难度，允许监控系统自动扩展。

监控系统按照配置规定的周期，定时抓取 URI 资源，得到信息解码，存储在内存中。

### 监控方式

- 黑盒监控
- 白盒监控
